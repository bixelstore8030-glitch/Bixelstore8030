<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>BIXEL Store</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAyyw14tck0mkhXBmPb5Xh--I4u2cBdhCQ",
  authDomain: "bixel-store-8030-8dc9b.firebaseapp.com",
  projectId: "bixel-store-8030-8dc9b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>

<style>
body{font-family:tahoma;background:#f4f4f4;text-align:center}
.box{background:#fff;padding:20px;margin:15px auto;width:90%;max-width:400px;border-radius:12px}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
button{background:#2196f3;color:#fff;border:none;font-weight:bold}
.order{border:1px solid #ddd;padding:8px;margin:6px 0;border-radius:8px;text-align:right}
.hidden{display:none}
.noOrders{color:#555;font-style:italic}
</style>
</head>

<body>

<h2>ðŸŸ¢ BIXEL STORE</h2>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="box" id="loginBox">
  <input id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
  <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <button onclick="showRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
</div>

<div class="box hidden" id="registerBox">
  <input id="regEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
  <input id="regPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="hideRegister()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<!-- Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ† -->
<div class="box hidden" id="userBox">
  <h3 id="balanceText">Ø§Ù„Ø±ØµÙŠØ¯: 0 BIXEL</h3>

  <select id="offer">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø±Ø¶</option>
  </select>

  <input type="number" id="quantity" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ (Ù…Ø¶Ø§Ø¹Ù 100)">
  <p id="price"></p>

  <input id="link" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
  <button onclick="sendOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
</div>

<!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
<div class="box hidden" id="ordersBox">
  <h3>ðŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
  <div id="myOrders"></div>
  <p id="noOrdersMsg" class="noOrders hidden">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>
</div>

<script>
let offers = {};
let currentBalance = 0;

// ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„
function showRegister(){loginBox.classList.add("hidden");registerBox.classList.remove("hidden");}
function hideRegister(){registerBox.classList.add("hidden");loginBox.classList.remove("hidden");}

function register(){
 auth.createUserWithEmailAndPassword(regEmail.value, regPass.value).then(res=>{
   db.collection("users").doc(res.user.uid).set({
     email: regEmail.value,
     bixel:0,
     role:"user"
   });
   alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨");
   hideRegister();
 });
}

function login(){
 auth.signInWithEmailAndPassword(email.value, pass.value);
}

// Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
auth.onAuthStateChanged(user=>{
 if(!user) return;

 loginBox.classList.add("hidden");
 registerBox.classList.add("hidden");
 userBox.classList.remove("hidden");
 ordersBox.classList.remove("hidden");

 // ØªØ­Ù…ÙŠÙ„ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
 db.collection("offers").onSnapshot(snap=>{
   offer.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø±Ø¶</option>';
   offers={};
   snap.forEach(doc=>{
     offers[doc.id]=doc.data();
     let o=document.createElement("option");
     o.value=doc.id;
     o.textContent=`${doc.data().name} (${doc.data().pricePer100} / 100 BIXEL)`;
     offer.appendChild(o);
   });
 });

 // Ø§Ù„Ø±ØµÙŠØ¯
 db.collection("users").doc(user.uid).onSnapshot(doc=>{
   currentBalance=doc.data().bixel||0;
   balanceText.innerText="Ø§Ù„Ø±ØµÙŠØ¯: "+currentBalance+" BIXEL";
 });

 loadMyOrders(user.uid);
});

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
quantity.oninput=calc;
offer.onchange=calc;
function calc(){
 if(!quantity.value||!offer.value){price.innerText="";return;}
 let cost=(quantity.value/100)*offers[offer.value].pricePer100;
 price.innerText="Ø§Ù„Ø³Ø¹Ø±: "+cost+" BIXEL";
}

// Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
function sendOrder(){
 let user=auth.currentUser;
 let q=Number(quantity.value);
 let o=offer.value;
 if(!q||!o||!link.value)return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
 let cost=(q/100)*offers[o].pricePer100;
 if(cost>currentBalance)return alert("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");

 db.collection("orders").add({
   userId:user.uid,
   email:user.email,
   offer:offers[o].name,
   quantity:q,
   bixelRequired:cost,
   link:link.value,
   status:"pending",
   createdAt:firebase.firestore.FieldValue.serverTimestamp()
 });
 alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
 quantity.value=""; link.value=""; price.innerText="";
}

// Ø·Ù„Ø¨Ø§ØªÙŠ
function loadMyOrders(uid){
 db.collection("orders").where("userId","==",uid)
 .onSnapshot(s=>{
   myOrders.innerHTML="";
   if(s.empty){noOrdersMsg.classList.remove("hidden");}
   else{
     noOrdersMsg.classList.add("hidden");
     s.forEach(d=>{
       let o=d.data();
       myOrders.innerHTML+=`
       <div class="order">
       ${o.offer}<br>
       ${o.quantity} | ${o.bixelRequired} BIXEL<br>
       ${o.status}
       </div>`;
     });
   }
 });
}
</script>

</body>
</html>