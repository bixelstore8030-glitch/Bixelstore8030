<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>BIXEL Store</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAyyw14tck0mkhXBmPb5Xh--I4u2cBdhCQ",
  authDomain: "bixel-store-8030-8dc9b.firebaseapp.com",
  projectId: "bixel-store-8030-8dc9b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>

<style>
body{font-family:tahoma;background:#f4f4f4;text-align:center}
.box{background:#fff;padding:20px;margin:15px auto;width:90%;max-width:400px;border-radius:12px}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
button{background:#2196f3;color:#fff;border:none;font-weight:bold;cursor:pointer}
.order{border:1px solid #ddd;padding:8px;margin:6px 0;border-radius:8px;text-align:right}
.hidden{display:none}
.noOrders{color:#555;font-style:italic}
#gameOfferInfo{background:#f2f2f2;padding:8px;border-radius:8px;margin-top:6px;text-align:right;font-size:14px;}
#offerNoteDisplay{font-size:13px;color:#333;margin-top:4px;text-align:right;}
</style>
</head>

<body>

<h2>ğŸŸ¢ BIXEL STORE</h2>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="box" id="loginBox">
  <input id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
  <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <button onclick="showRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
</div>

<div class="box hidden" id="registerBox">
  <input id="regEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
  <input id="regPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="hideRegister()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<!-- Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ† -->
<div class="box hidden" id="userBox">
  <h3 id="balanceText">Ø§Ù„Ø±ØµÙŠØ¯: 0 BIXEL</h3>

  <!-- Ø²Ø± Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶ -->
  <button id="toggleUserOffersBtn" class="hidden" onclick="toggleUserOffers()">Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†</button>

  <select id="offer">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø±Ø¶</option>
  </select>

  <div id="offerNoteDisplay" class="hidden"></div>

  <input type="number" id="quantity" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ (Ù…Ø¶Ø§Ø¹Ù 100)">
  <p id="price"></p>

  <input id="link" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·">
  <button onclick="sendOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
</div>

<!-- Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬ -->
<div class="box hidden" id="gamesBox">
  <h3>ğŸ® Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬</h3>

  <select id="gameOffer">
    <option value="">Ø§Ø®ØªØ± Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø­Ù†</option>
  </select>

  <div id="gameOfferInfo" class="hidden"></div>

  <input type="number" id="gameQty" placeholder="Ø§Ù„Ø¹Ø¯Ø¯">
  <p id="gamePrice"></p>

  <input id="gameAccount" placeholder="ID / Email / Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨">
  <button onclick="sendGameOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†</button>
</div>

<!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
<div class="box hidden" id="ordersBox">
  <h3>ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
  <button id="toggleOrdersBtn">Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§ØªÙŠ</button>
  <div id="myOrders" class="hidden"></div>
  <p id="noOrdersMsg" class="noOrders hidden">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>
</div>

<script>
let offers = {};
let currentBalance = 0;
let gameOffers = {};
let userOffersVisible = true;

// ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„
function showRegister(){loginBox.classList.add("hidden");registerBox.classList.remove("hidden");}
function hideRegister(){registerBox.classList.add("hidden");loginBox.classList.remove("hidden");}

function register(){
 auth.createUserWithEmailAndPassword(regEmail.value, regPass.value).then(res=>{
   db.collection("users").doc(res.user.uid).set({
     email: regEmail.value,
     bixel:0,
     role:"user"
   });
   alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨");
   hideRegister();
 });
}

function login(){
 auth.signInWithEmailAndPassword(email.value, pass.value);
}

// Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
auth.onAuthStateChanged(user=>{
 if(!user) return;

 loginBox.classList.add("hidden");
 registerBox.classList.add("hidden");
 userBox.classList.remove("hidden");
 ordersBox.classList.remove("hidden");
 gamesBox.classList.remove("hidden");

 // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø¹Ø±Ø¶ Ø²Ø± Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ¶
 db.collection("settings").doc("userOffers").get().then(doc=>{
   if(doc.exists && doc.data().visible === false){
     toggleUserOffersBtn.classList.remove("hidden");
     hideUserOffers();
   }
 });

 // ØªØ­Ù…ÙŠÙ„ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
 db.collection("offers").onSnapshot(snap=>{
   offer.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø±Ø¶</option>';
   offers={};
   snap.forEach(doc=>{
     offers[doc.id]=doc.data();
     let o=document.createElement("option");
     o.value=doc.id;
     o.textContent=`${doc.data().name} (${doc.data().pricePer100} / 100 BIXEL)`;
     offer.appendChild(o);
   });
 });

 // ØªØ­Ù…ÙŠÙ„ Ø¹Ø±ÙˆØ¶ Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
 db.collection("game_offers").where("active","==",true)
 .onSnapshot(snap=>{
   gameOffer.innerHTML='<option value="">Ø§Ø®ØªØ± Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø­Ù†</option>';
   gameOffers={};
   snap.forEach(doc=>{
     gameOffers[doc.id]=doc.data();
     let o=document.createElement("option");
     o.value=doc.id;
     o.textContent=`${doc.data().name} (${doc.data().pricePerUnit} BIXEL)`;
     gameOffer.appendChild(o);
   });
 });

 // Ø§Ù„Ø±ØµÙŠØ¯
 db.collection("users").doc(user.uid).onSnapshot(doc=>{
   currentBalance=doc.data().bixel||0;
   balanceText.innerText="Ø§Ù„Ø±ØµÙŠØ¯: "+currentBalance+" BIXEL";
 });

 loadMyOrders(user.uid);
});

// ÙˆØ¸Ø§Ø¦Ù Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
function toggleUserOffers(){
 if(userOffersVisible){ hideUserOffers(); }
 else{ showUserOffers(); }
}

function hideUserOffers(){
 offer.style.display="none";
 quantity.style.display="none";
 link.style.display="none";
 price.style.display="none";
 offerNoteDisplay.style.display="none";
 userOffersVisible=false;
 toggleUserOffersBtn.textContent="Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†";
}

function showUserOffers(){
 offer.style.display="block";
 quantity.style.display="block";
 link.style.display="block";
 price.style.display="block";
 offerNoteDisplay.style.display="block";
 userOffersVisible=true;
 toggleUserOffersBtn.textContent="Ø¥Ø®ÙØ§Ø¡ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†";
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
quantity.oninput=calc;
offer.onchange=calc;
function calc(){
 if(!quantity.value||!offer.value){price.innerText=""; offerNoteDisplay.classList.add("hidden"); return;}
 let oData = offers[offer.value];
 let cost=(quantity.value/100)*oData.pricePer100;
 price.innerText="Ø§Ù„Ø³Ø¹Ø±: "+cost+" BIXEL";
 if(oData.note){
   offerNoteDisplay.classList.remove("hidden");
   offerNoteDisplay.innerText="ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: "+oData.note;
 } else {
   offerNoteDisplay.classList.add("hidden");
 }
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¹Ø±ÙˆØ¶ Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
gameOffer.onchange = calcGame;
gameQty.oninput = calcGame;
function calcGame(){
  if(!gameOffer.value || !gameQty.value){
    gamePrice.innerText = "";
    gameOfferInfo.classList.add("hidden");
    return;
  }

  let o = gameOffers[gameOffer.value];
  let cost = gameQty.value * o.pricePerUnit;

  gamePrice.innerText = "Ø§Ù„Ø³Ø¹Ø±: " + cost + " BIXEL";
  gameOfferInfo.classList.remove("hidden");
  gameOfferInfo.innerHTML = `
    ğŸ® ${o.name}<br>
    ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ù„Ù„ÙˆØ­Ø¯Ø©: ${o.pricePerUnit} BIXEL<br>
    ğŸ“ ${o.note || ""}
  `;
}

// Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
function sendOrder(){
 let user=auth.currentUser;
 let q=Number(quantity.value);
 let o=offer.value;
 if(!q||!o||!link.value)return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
 let cost=(q/100)*offers[o].pricePer100;
 if(cost>currentBalance)return alert("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");

 db.collection("orders").add({
   userId:user.uid,
   email:user.email,
   offer:offers[o].name,
   quantity:q,
   bixelRequired:cost,
   link:link.value,
   note:offers[o].note||"",
   status:"pending",
   createdAt:firebase.firestore.FieldValue.serverTimestamp()
 });
 alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
 quantity.value=""; link.value=""; price.innerText="";
 offerNoteDisplay.classList.add("hidden");
}

// Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
function sendGameOrder(){
  let user = auth.currentUser;

  if(!gameOffer.value || !gameQty.value || !gameAccount.value)
    return alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†");

  let o = gameOffers[gameOffer.value];
  let cost = gameQty.value * o.pricePerUnit;

  if(cost > currentBalance)
    return alert("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");

  db.collection("orders").add({
    type: "game_charge",
    userId: user.uid,
    email: user.email,
    offerId: gameOffer.value,
    offerName: o.name,
    quantity: Number(gameQty.value),
    unit: o.unitName,
    bixelRequired: cost,
    account: gameAccount.value,
    status: "pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†");
  gameQty.value = "";
  gameAccount.value = "";
  gamePrice.innerText = "";
  gameOfferInfo.classList.add("hidden");
}

// Ø·Ù„Ø¨Ø§ØªÙŠ
function loadMyOrders(uid){
 db.collection("orders").where("userId","==",uid)
 .onSnapshot(s=>{
   myOrders.innerHTML="";
   if(s.empty){noOrdersMsg.classList.remove("hidden");}
   else{
     noOrdersMsg.classList.add("hidden");
     s.forEach(d=>{
       let o=d.data();
       if(o.type === "game_charge"){
         myOrders.innerHTML+=`
         <div class="order">
         ğŸ® ${o.offerName}<br>
         ${o.quantity} ${o.unit} | ${o.bixelRequired} BIXEL<br>
         Ø§Ù„Ø­Ø³Ø§Ø¨: <a href="${o.account}" target="_blank">${o.account}</a><br>
         ${o.status}
         </div>`;
       } else {
         myOrders.innerHTML+=`
         <div class="order">
         ${o.offer}<br>
         ${o.quantity} | ${o.bixelRequired} BIXEL<br>
         Ø§Ù„Ø±Ø§Ø¨Ø·: <a href="${o.link}" target="_blank">${o.link}</a><br>
         ğŸ“ ${o.note || "-"}<br>
         ${o.status}
         </div>`;
       }
     });
   }
 });
}

// Ø²Ø± Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
let toggleBtn = document.getElementById("toggleOrdersBtn");
let ordersDiv = document.getElementById("myOrders");
toggleBtn.addEventListener("click", function() {
    if (ordersDiv.classList.contains("hidden")) {
        ordersDiv.classList.remove("hidden");
        toggleBtn.textContent = "Ø¥Ø®ÙØ§Ø¡ Ø·Ù„Ø¨Ø§ØªÙŠ";
    } else {
        ordersDiv.classList.add("hidden");
        toggleBtn.textContent = "Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§ØªÙŠ";
    }
});
</script>

</body>
</html>
