<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>BIXEL Admin</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAyyw14tck0mkhXBmPb5Xh--I4u2cBdhCQ",
  authDomain: "bixel-store-8030-8dc9b.firebaseapp.com",
  projectId: "bixel-store-8030-8dc9b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let ordersListener = null;
</script>

<style>
body{font-family:tahoma;background:#f2f2f2;text-align:center}
.box{background:#fff;padding:20px;margin:15px auto;width:90%;max-width:500px;border-radius:12px}
.order,.offer,.gameOffer{border:1px solid #ddd;padding:10px;margin:8px 0;border-radius:8px;text-align:right}
input,button,select{width:100%;padding:10px;margin:5px 0;border-radius:8px}
button{background:#2196f3;color:#fff;border:none;font-weight:bold;cursor:pointer}
button.approve{background:#4caf50}
button.reject{background:#f44336}
button.edit{background:#ff9800}
button.save{background:#4caf50}
button.show-offers{background:#009688}
button.delete-orders{background:#e91e63}
.counter{font-weight:bold;margin-left:10px}
.counter.pending{color:orange}
.counter.approved{color:green}
.counter.rejected{color:red}
.counter.all{color:blue}
.hidden{display:none}
.countdown{font-weight:bold;margin-left:5px;color:#000}
</style>
</head>

<body>

<h2>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© BIXEL</h2>

<div id="loginBox" class="box">
  <h3>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
  <input id="adminEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
  <input id="adminPass" type="password">
  <button onclick="adminLogin()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="adminBox" class="hidden">

<!-- ÙÙ„ØªØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
<div class="box">
  <select id="filterStatus" onchange="loadOrders()">
    <option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option>
    <option value="approved">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</option>
    <option value="rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
    <option value="all">Ø§Ù„ÙƒÙ„</option>
  </select>
  <div style="margin-top:10px">
    <button class="delete-orders" onclick="deleteOrders('pending')">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</button>
    <span id="pendingCount" class="counter pending">0</span>
    <button class="delete-orders" onclick="deleteOrders('approved')">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</button>
    <span id="approvedCount" class="counter approved">0</span>
    <button class="delete-orders" onclick="deleteOrders('rejected')">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</button>
    <span id="rejectedCount" class="counter rejected">0</span>
    <button class="delete-orders" onclick="deleteOrders('all')">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    <span id="allCount" class="counter all">0</span>
    <span id="countdownTimer" class="countdown hidden"></span>
  </div>
</div>

<!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
<div class="box">
  <h3>ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
  <div id="orders"></div>
</div>

<!-- Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ† -->
<div class="box">
  <h3>â• Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†</h3>
  <input id="offerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶">
  <input id="offerPrice" type="number" placeholder="Ø³Ø¹Ø± ÙƒÙ„ 100 BIXEL">
  <input id="offerLink" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <input id="offerNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <button onclick="addOffer()">Ø¥Ø¶Ø§ÙØ©</button>
  <button onclick="toggleAdminOffers()">ğŸ‘ï¸ Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†</button>
  <div id="offersList"></div>
</div>

<!-- Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ -->
<div class="box">
  <h3>â• Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨/Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬</h3>
  <input id="gameName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶">
  <input type="number" id="gamePrice" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© BIXEL">
  <input id="gameUnit" placeholder="Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Ø«Ù„ UC Ø£Ùˆ Gems)">
  <input id="gameNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
  <button onclick="addGameOffer()">Ø¥Ø¶Ø§ÙØ©</button>
  <button onclick="toggleGameOffers()">ğŸ‘ï¸ Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</button>
  <div id="gameOffersList"></div>
</div>

<!-- Ø´Ø­Ù† ÙŠØ¯ÙˆÙŠ -->
<div class="box">
  <h3>â• Ø´Ø­Ù† ÙŠØ¯ÙˆÙŠ</h3>
  <input id="userId" placeholder="UID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <input id="amount" type="number" placeholder="ÙƒÙ…ÙŠØ© BIXEL">
  <button onclick="addBixel()">Ø¥Ø¶Ø§ÙØ©</button>
</div>

<button onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</div>

<script>
// ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±
function adminLogin(){
  if(ordersListener){ ordersListener(); ordersListener = null; }
  auth.signInWithEmailAndPassword(adminEmail.value, adminPass.value)
    .then(res=>{
      db.collection("users").doc(res.user.uid).get().then(doc=>{
        if(doc.exists && doc.data().role==="admin"){
          loginBox.classList.add("hidden");
          adminBox.classList.remove("hidden");
          loadOrders();
          loadOffers();
          loadGameOffers();
        } else {
          alert("âŒ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ");
          auth.signOut();
        }
      });
    }).catch(err=>alert(err.message));
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
function loadOrders(){
  let status = filterStatus.value;

  if(ordersListener){ ordersListener(); ordersListener=null; }

  ordersListener = db.collection("orders").orderBy("createdAt","desc").onSnapshot(snap=>{
    orders.innerHTML="";
    let pending=0, approved=0, rejected=0, all=0;

    snap.forEach(doc=>{
      let d = doc.data();
      all++;
      if(d.status==="pending") pending++;
      if(d.status==="approved") approved++;
      if(d.status==="rejected") rejected++;

      if(status!=="all" && d.status!==status) return;

      let buttons="";
      if(d.status==="pending"){
        buttons=`<button class="approve" onclick="approve('${doc.id}','${d.userId}',${d.bixelRequired})">âœ” Ù…ÙˆØ§ÙÙ‚Ø©</button>
                 <button class="reject" onclick="reject('${doc.id}')">âœ– Ø±ÙØ¶</button>`;
      }

      let statusText =
        d.status==="approved"?"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©":
        d.status==="rejected"?"âŒ Ù…Ø±ÙÙˆØ¶":
        "â³ Ù…Ø¹Ù„Ù‚Ø©";

      if(d.type==="game_charge"){
        orders.innerHTML += `
        <div class="order" id="order-${doc.id}">
          ğŸ® ${d.offerName} | ${d.quantity} ${d.unit} | ${d.bixelRequired} BIXEL<br>
          Ø§Ù„Ø­Ø³Ø§Ø¨: ${d.account}<br>
          ğŸŸ¢ ${statusText}<br>
          ${buttons}
        </div>`;
      } else {
        orders.innerHTML += `
        <div class="order" id="order-${doc.id}">
          ğŸ“§ ${d.email}<br>
          ğŸ“¦ ${d.offer}<br>
          ğŸ”¢ ${d.quantity}<br>
          ğŸ’° ${d.bixelRequired} BIXEL<br>
          ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: <a href="${d.link}" target="_blank">${d.link}</a><br>
          ğŸŸ¢ ${statusText}<br>
          ${buttons}
        </div>`;
      }
    });

    document.getElementById("pendingCount").innerText=pending;
    document.getElementById("approvedCount").innerText=approved;
    document.getElementById("rejectedCount").innerText=rejected;
    document.getElementById("allCount").innerText=all;

    if(orders.innerHTML==="") orders.innerHTML="<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©</p>";
  });
}

// Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª
function deleteOrders(type){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ")) return;

  let countdownEl = document.getElementById("countdownTimer");
  let seconds = 5;
  countdownEl.innerText = `Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ø¹Ø¯ ${seconds} Ø«Ø§Ù†ÙŠØ©`;
  countdownEl.classList.remove("hidden");

  let interval = setInterval(()=>{
    seconds--;
    if(seconds>0){
      countdownEl.innerText = `Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ø¹Ø¯ ${seconds} Ø«Ø§Ù†ÙŠØ©`;
    } else {
      clearInterval(interval);
      countdownEl.classList.add("hidden");
      db.collection("orders").get().then(snap=>{
        snap.forEach(doc=>{
          let d = doc.data();
          if(type==="all" || d.status===type){
            db.collection("orders").doc(doc.id).delete();
          }
        });
      });
    }
  },1000);
}

// Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
let adminOffersVisible = true;
function toggleAdminOffers(){
  const offersEl = document.getElementById("offersList");
  adminOffersVisible = !adminOffersVisible;
  offersEl.classList.toggle("hidden", !adminOffersVisible);
  alert(adminOffersVisible ? "âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†" : "âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†");
}

function addOffer(){
  let name=offerName.value.trim();
  let price=Number(offerPrice.value);
  let link=offerLink.value.trim();
  let note=offerNote.value.trim();
  if(!name || !price) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  db.collection("offers").add({name,pricePer100:price,link,note});
  offerName.value=""; offerPrice.value=""; offerLink.value=""; offerNote.value="";
}
function loadOffers(){
  db.collection("offers").onSnapshot(snapshot=>{
    offersList.innerHTML="";
    snapshot.forEach(doc=>{
      let o = doc.data();
      offersList.innerHTML += `
      <div class="offer">
        <input value="${o.name}" onchange="updateOffer('${doc.id}',this.value,'${o.link}','${o.note}','${o.pricePer100}')">
        <input type="number" value="${o.pricePer100}" onchange="updateOffer('${doc.id}','${o.name}','${o.link}','${o.note}',this.value)">
        <input value="${o.link||''}" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·" onchange="updateOffer('${doc.id}', '${o.name}', this.value, '${o.note}', ${o.pricePer100})">
        <input value="${o.note||''}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" onchange="updateOffer('${doc.id}', '${o.name}', '${o.link}', this.value, ${o.pricePer100})">
        <button class="save" onclick="saveOffer('${doc.id}', this)">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="delete" onclick="deleteOffer('${doc.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>`;
    });
  });
}
function updateOffer(id,newName,newLink,newNote,newPrice){
  db.collection("offers").doc(id).update({name:newName,link:newLink,note:newNote,pricePer100:Number(newPrice)});
}
function saveOffer(id, btn){
  btn.innerText="âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸";
  setTimeout(()=>{btn.innerText="ğŸ’¾ Ø­ÙØ¸";},1500);
}
function deleteOffer(docId){ if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ØŸ")) db.collection("offers").doc(docId).delete(); }

// Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
let adminGameOffersVisible = true;
function toggleGameOffers(){
  const el = document.getElementById("gameOffersList");
  adminGameOffersVisible = !adminGameOffersVisible;
  el.classList.toggle("hidden", !adminGameOffersVisible);
  alert(adminGameOffersVisible ? "âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨" : "âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨");
}

function loadGameOffers(){
  db.collection("game_offers").onSnapshot(snap=>{
    gameOffersList.innerHTML="";
    snap.forEach(doc=>{
      let o = doc.data();
      gameOffersList.innerHTML += `
      <div class="gameOffer">
        ${o.name} - ${o.pricePerUnit} BIXEL / ${o.unitName}<br>
        Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${o.note || "-"}<br>
        <button class="edit" onclick="editGameOffer('${doc.id}','${o.name}',${o.pricePerUnit},'${o.unitName}','${o.note || ""}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="delete" onclick="deleteGameOffer('${doc.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>`;
    });
  });
}
function addGameOffer(){
  let name=gameName.value.trim();
  let price=Number(gamePrice.value);
  let unit=gameUnit.value.trim();
  let note=gameNote.value.trim();
  if(!name || !price || !unit) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  db.collection("game_offers").add({name,pricePerUnit:price,unitName:unit,note,active:true});
  gameName.value=""; gamePrice.value=""; gameUnit.value=""; gameNote.value="";
}
function editGameOffer(docId, oldName, oldPrice, oldUnit, oldNote){
  let newName=prompt("Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯:",oldName);
  if(newName===null) return;
  let newPrice=prompt("Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© BIXEL:",oldPrice);
  if(newPrice===null) return;
  newPrice=Number(newPrice);
  let newUnit=prompt("Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:",oldUnit);
  if(newUnit===null) return;
  let newNote=prompt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª:",oldNote);
  if(newNote===null) return;
  db.collection("game_offers").doc(docId).update({name:newName.trim(),pricePerUnit:newPrice,unitName:newUnit.trim(),note:newNote});
  alert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶");
}
function deleteGameOffer(docId){ if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ØŸ")) db.collection("game_offers").doc(docId).delete(); }

// Ø´Ø­Ù† ÙŠØ¯ÙˆÙŠ
function addBixel(){
  let uid=userId.value.trim();
  let amt=Number(amount.value);
  if(!uid||!amt){ alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
  let ref=db.collection("users").doc(uid);
  ref.get().then(doc=>{
    if(doc.exists){ ref.update({bixel:(doc.data().bixel||0)+amt}); alert("âœ… ØªÙ… Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­"); }
    else alert("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  });
}

// Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
function approve(orderId, uid, cost){
  let ref=db.collection("users").doc(uid);
  ref.get().then(doc=>{
    let bal=doc.data().bixel||0;
    if(bal<cost){ alert("âŒ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ÙƒØ§ÙÙ"); return; }
    ref.update({bixel:bal-cost});
    db.collection("orders").doc(orderId).update({status:"approved", executed:true, executedAt:firebase.firestore.FieldValue.serverTimestamp()});
    document.getElementById(`order-${orderId}`).remove();
    loadOrders();
    alert("âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯");
  });
}
function reject(orderId){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ØŸ")){
    db.collection("orders").doc(orderId).update({status:"rejected"});
    document.getElementById(`order-${orderId}`).remove();
    loadOrders();
  }
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
function logout(){
  if(ordersListener){ ordersListener(); ordersListener=null; }
  auth.signOut();
  location.reload();
}
</script>

</body>
</html>
